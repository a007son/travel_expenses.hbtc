<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Google地圖差旅網址產生器</title>
    <style>
        /* --- Fluent Design Inspired Styles --- */
        :root {
            --accent-color: #0078D4;
            --accent-color-hover: #005A9E;
            --success-color: #107C10;
            --danger-color: #D83B01;
            --light-gray: #f3f3f3;
            --medium-gray: #e1e1e1;
            --dark-gray: #666;
            --text-color: #212121;
            --font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Microsoft JhengHei", Roboto, "Helvetica Neue", Arial, sans-serif;
            --border-radius: 4px;
            --shadow-sm: 0 1px 2px rgba(0,0,0,0.1);
            --shadow-md: 0 4px 8px rgba(0,0,0,0.1);
        }
        body {
            font-family: var(--font-family);
            margin: 0;
            padding: 2em;
            background-color: var(--light-gray);
            color: var(--text-color);
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: #fff;
            padding: 2em 2.5em;
            border-radius: 8px;
            box-shadow: var(--shadow-md);
            border: 1px solid var(--medium-gray);
        }
        h1 {
            color: #000;
            text-align: center;
            margin-bottom: 1.5em;
            font-weight: 600;
        }
		h4
		 {
            color: #000;
            text-align: center;
            font-weight: 600;
        }
        /* --- Start/End Points --- */
        .endpoints-section {
            background: #fafafa;
            border: 1px solid var(--medium-gray);
            padding: 1.5em;
            margin-bottom: 2em;
            border-radius: var(--border-radius);
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.5em;
        }
        .input-group {
            margin-bottom: 1em;
        }
        label {
            display: block;
            margin-bottom: .5em;
            font-weight: 600;
            color: var(--dark-gray);
            font-size: 0.9em;
        }
        input[type="text"], input[type="file"], select {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--medium-gray);
            border-radius: var(--border-radius);
            box-sizing: border-box;
            font-size: 1em;
            transition: box-shadow 0.2s, border-color 0.2s;
        }
        input:focus, select:focus {
            outline: none;
            border-color: var(--accent-color);
            box-shadow: 0 0 0 2px rgba(0, 120, 212, 0.3);
        }
        /* --- Tabs --- */
        .tab-container {
            display: flex;
            border-bottom: 1px solid var(--medium-gray);
            margin-bottom: 1.5em;
        }
        .tab {
            padding: 10px 20px;
            cursor: pointer;
            background-color: transparent;
            border: none;
            border-bottom: 2px solid transparent;
            margin-bottom: -1px;
            font-size: 1em;
            font-weight: 500;
            color: var(--dark-gray);
            transition: color 0.2s, border-color 0.2s;
        }
        .tab:hover {
            color: #000;
        }
        .tab.active {
            color: var(--accent-color);
            border-bottom-color: var(--accent-color);
            font-weight: 600;
        }
        .tab-content { display: none; }
        .tab-content.active { display: block; }

        /* --- Buttons --- */
        .btn {
            padding: 10px 18px;
            border: 1px solid transparent;
            border-radius: var(--border-radius);
            font-size: 1em;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }
        .btn-primary {
            background-color: var(--accent-color);
            color: white;
        }
        .btn-primary:hover {
            background-color: var(--accent-color-hover);
            box-shadow: var(--shadow-sm);
        }
        .btn-secondary {
            background-color: #fff;
            color: var(--text-color);
            border-color: #ccc;
        }
        .btn-secondary:hover {
            background-color: #f9f9f9;
            border-color: #bbb;
        }
        .btn-danger {
            background: var(--danger-color);
            color: white;
            font-weight: bold;
            padding: 5px 10px;
        }
        .btn-danger:hover {
            opacity: 0.85;
        }
        .add-btn {
            margin-top: 10px;
            background-color: var(--success-color);
            color: white;
        }
        .add-btn:hover {
            background-color: #0E5B0E;
        }
        .main-btn {
            width: 100%;
            padding: 14px;
            font-size: 1.2em;
            font-weight: 600;
            margin-top: 2em;
        }
        .address-list .input-group {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: .75em;
        }
        .address-list input[type="text"] {
            flex-grow: 1;
        }

        /* --- Result Area --- */
        #result-container {
            margin-top: 2em;
            padding: 1.5em;
            background-color: #f8f8f8;
            border-radius: var(--border-radius);
            border: 1px solid var(--medium-gray);
            display: none; /* Initially hidden */
        }
        .result-input-wrapper {
            display: flex;
            gap: 10px;
            margin-bottom: 1em;
        }
        #result-url {
            flex-grow: 1;
        }
        .result-buttons {
            display: flex;
            gap: 10px;
        }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body>

    <div class="container">
        <h1>Google地圖差旅網址產生器</h1>
		<h4>by a007son with Gemini</h4>

        <div class="endpoints-section">
            <div class="input-group">
                <label for="start-point">起點 (選填)</label>
                <input type="text" id="start-point" placeholder="例如：臺中火車站">
            </div>
            <div class="input-group">
                <label for="end-point">終點 (選填)</label>
                <input type="text" id="end-point" placeholder="例如：臺北101">
            </div>
        </div>

        <div class="tab-container">
            <button class="tab active" onclick="showTab('manual')">手動輸入中途點</button>
            <button class="tab" onclick="showTab('excel')">從 Excel 匯入中途點</button>
        </div>

        <div id="manual" class="tab-content active">
            <div id="address-list">
                <div class="input-group">
                    <input type="text" placeholder="中途點 1" class="address-input">
                </div>
                <div class="input-group">
                    <input type="text" placeholder="中途點 2" class="address-input">
                </div>
            </div>
            <button class="btn add-btn" onclick="addAddressRow()">＋ 新增中途點</button>
        </div>

        <div id="excel" class="tab-content">
            <div class="input-group">
                <label for="excel-file">選擇 Excel (.xlsx, .xls, .csv) 檔案：</label>
                <input type="file" id="excel-file" accept=".xlsx, .xls, .csv">
            </div>
            <div class="input-group">
                <label for="column-selector">請選擇包含地址的欄位：</label>
                <select id="column-selector" disabled>
                    <option>請先上傳檔案</option>
                </select>
            </div>
        </div>

        <button class="btn btn-primary main-btn" onclick="generateUrl()">產生路徑網址</button>

        <div id="result-container">
            <label for="result-url">產生的網址 (可直接開啟)：</label>
            <div class="result-input-wrapper">
                 <input type="text" id="result-url" readonly title="此為方便閱讀的網址，複製請使用右方按鈕">
            </div>
            <div class="result-buttons">
                <a href="#" id="open-link-btn" target="_blank" class="btn btn-primary">在新分頁開啟</a>
                <button id="copy-btn" class="btn btn-secondary" onclick="copyUrl()">複製網址</button>
            </div>
        </div>
    </div>

    <script>
        const MAX_LOCATIONS = 24;
        let selectedColumnData = [];
        let encodedUrlForCopy = '';

        // Tab切換邏輯
        function showTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.getElementById(tabName).classList.add('active');
            document.querySelector(`.tab[onclick="showTab('${tabName}')"]`).classList.add('active');
        }

        // 手動輸入：新增地址欄位
        function addAddressRow() {
            const list = document.getElementById('address-list');
            // 起點和終點也算在內，所以這裡要扣掉2
            const currentCount = list.getElementsByClassName('address-input').length + 2; 
            if (currentCount >= MAX_LOCATIONS) {
                alert(`最多只能新增 ${MAX_LOCATIONS} 個地點(含起點/終點)。`);
                return;
            }
            const newRow = document.createElement('div');
            newRow.className = 'input-group';
            newRow.innerHTML = `
                <input type="text" placeholder="中途點 ${list.children.length + 1}" class="address-input">
                <button class="btn btn-danger" onclick="this.parentElement.remove()" title="移除此地點">✕</button>
            `;
            list.appendChild(newRow);
        }

        // Excel 檔案處理
        document.getElementById('excel-file').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, {type: 'array'});
                    const firstSheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheetName];
                    const json = XLSX.utils.sheet_to_json(worksheet, { header: 1 });

                    if (json.length === 0) {
                        alert('Excel檔案為空或格式不符！');
                        return;
                    }
                    
                    const columnSelector = document.getElementById('column-selector');
                    columnSelector.innerHTML = '';
                    columnSelector.disabled = false;
                    const headers = json[0] || [];
                    headers.forEach((header, index) => {
                        const option = document.createElement('option');
                        option.value = index;
                        option.textContent = `第 ${String.fromCharCode(65 + index)} 欄: ${header || '(空)'}`;
                        columnSelector.appendChild(option);
                    });

                    columnSelector.onchange = function() {
                        const colIndex = this.value;
                        selectedColumnData = json.slice(1)
                                                .map(row => row[colIndex])
                                                .filter(cell => cell != null && cell.toString().trim() !== '');
                    };
                    columnSelector.dispatchEvent(new Event('change'));
                } catch (error) {
                    alert('讀取檔案時發生錯誤，請確認檔案格式是否正確。');
                    console.error(error);
                }
            };
            reader.readAsArrayBuffer(file);
        });

        // 主要功能：產生網址
        function generateUrl() {
            const startPoint = document.getElementById('start-point').value.trim();
            const endPoint = document.getElementById('end-point').value.trim();
            const activeTab = document.querySelector('.tab-content.active').id;
            
            let intermediatePoints = [];
            if (activeTab === 'manual') {
                document.querySelectorAll('#address-list .address-input').forEach(input => {
                    const value = input.value.trim();
                    if (value) intermediatePoints.push(value);
                });
            } else { // excel
                intermediatePoints = selectedColumnData;
            }

            let allAddresses = [startPoint, ...intermediatePoints, endPoint].filter(addr => addr);

            if (allAddresses.length < 2) {
                alert('請至少提供兩個地點（可以是起點和終點）！');
                return;
            }
            if (allAddresses.length > MAX_LOCATIONS) {
                 alert(`總地點數量 (${allAddresses.length}) 超過 ${MAX_LOCATIONS} 個，將只會使用前 ${MAX_LOCATIONS} 個。`);
                 allAddresses = allAddresses.slice(0, MAX_LOCATIONS);
            }

            const baseUrl = 'https://www.google.com.tw/maps/dir/';
            
            // 產生給瀏覽器用的編碼後 URL
            encodedUrlForCopy = baseUrl + allAddresses.map(addr => encodeURIComponent(addr)).join('/');
            
            // 產生給使用者看的未編碼 URL
            const decodedUrl = baseUrl + allAddresses.join('/');

            const resultContainer = document.getElementById('result-container');
            const resultUrlInput = document.getElementById('result-url');
            const openLinkBtn = document.getElementById('open-link-btn');

            resultUrlInput.value = decodedUrl;
            openLinkBtn.href = encodedUrlForCopy;
            resultContainer.style.display = 'block';
            
            // 重置複製按鈕狀態
            const copyBtn = document.getElementById('copy-btn');
            copyBtn.textContent = '複製網址';
            copyBtn.disabled = false;
        }

        // 複製功能
        async function copyUrl() {
            if (!encodedUrlForCopy) return;
            try {
                await navigator.clipboard.writeText(encodedUrlForCopy);
                const copyBtn = document.getElementById('copy-btn');
                copyBtn.textContent = '已複製！';
                copyBtn.disabled = true;
                setTimeout(() => {
                    copyBtn.textContent = '複製網址';
                    copyBtn.disabled = false;
                }, 2000);
            } catch (err) {
                alert('複製失敗，您的瀏覽器可能不支援此功能。');
                console.error('Copy failed: ', err);
            }
        }
    </script>
</body>
</html>